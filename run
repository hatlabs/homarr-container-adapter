#!/usr/bin/env bash
#
# usage: ./run command [argument ...]
#
# Commands for developing homarr-container-adapter.
#
# See https://death.andgravity.com/run-sh
# for an explanation of how it works and why it's useful.

set -o nounset
set -o pipefail
set -o errexit

# Change the current directory to the project root.
PROJECT_ROOT=${0%/*}
if [[ $0 != $PROJECT_ROOT && $PROJECT_ROOT != "" ]]; then
  cd "$PROJECT_ROOT"
fi
readonly PROJECT_ROOT=$(pwd)

# Store the absolute path to this script (useful for recursion).
readonly SCRIPT="$PROJECT_ROOT/$(basename "$0")"

# Docker image name for cross-compilation
readonly DOCKER_IMAGE="homarr-adapter-builder"

################################################################################
# Build Commands

function build {
  #@ Build debug binary (native)
  #@ Category: Build
  echo "Building debug binary..."
  cargo build
}

function build-release {
  #@ Build release binary (native)
  #@ Category: Build
  echo "Building release binary..."
  cargo build --release
}

function build-arm64 {
  #@ Cross-compile release binary for ARM64 (aarch64-unknown-linux-gnu)
  #@ Category: Build
  echo "Cross-compiling for ARM64..."

  # Ensure Docker image exists
  if ! docker image inspect "$DOCKER_IMAGE" &>/dev/null; then
    echo "Docker image not found. Building..."
    docker-build-image
  fi

  docker run --rm -v "$(pwd):/build" "$DOCKER_IMAGE" \
    cargo build --release --target aarch64-unknown-linux-gnu

  echo ""
  echo "Binary built at: target/aarch64-unknown-linux-gnu/release/homarr-container-adapter"
}

function docker-build-image {
  #@ Build the Docker image for ARM64 cross-compilation
  #@ Category: Build
  echo "Building Docker cross-compilation image..."
  docker build -t "$DOCKER_IMAGE" -f docker/Dockerfile.debtools .
}

################################################################################
# Test Commands

function test {
  #@ Run all tests
  #@ Category: Test
  echo "Running tests..."
  cargo test
}

function test-unit {
  #@ Run unit tests only (faster)
  #@ Category: Test
  echo "Running unit tests..."
  cargo test --lib
}

function clippy {
  #@ Run clippy linter
  #@ Category: Test
  echo "Running clippy..."
  cargo clippy
}

function fmt {
  #@ Format code with rustfmt
  #@ Category: Test
  echo "Formatting code..."
  cargo fmt
}

function fmt-check {
  #@ Check code formatting without modifying
  #@ Category: Test
  echo "Checking code formatting..."
  cargo fmt --check
}

function check {
  #@ Run cargo check (fast compilation check)
  #@ Category: Test
  echo "Running cargo check..."
  cargo check
}

function lint {
  #@ Run all linting checks (fmt-check + clippy)
  #@ Category: Test
  echo "Running all linting checks..."
  cargo fmt --check
  cargo clippy
}

################################################################################
# Deploy Commands

function deploy {
  #@ Deploy ARM64 binary to test server
  #@ Usage: ./run deploy <target_host>
  #@ Category: Deploy
  local target="${1:-}"

  if [[ -z "$target" ]]; then
    echo "Usage: ./run deploy <target_host>"
    echo ""
    echo "Example: ./run deploy pi@myhost.local"
    return 1
  fi

  echo "Deploying to $target..."

  # Build if needed
  local binary="target/aarch64-unknown-linux-gnu/release/homarr-container-adapter"
  if [ ! -f "$binary" ]; then
    echo "Binary not found. Building..."
    build-arm64
  fi

  echo "Copying binary to $target..."
  scp "$binary" "$target:/tmp/"

  echo "Installing binary and restarting service..."
  ssh "$target" "sudo systemctl stop homarr-container-adapter && \
    sudo cp /tmp/homarr-container-adapter /usr/bin/ && \
    sudo chmod +x /usr/bin/homarr-container-adapter && \
    sudo systemctl start homarr-container-adapter"

  echo ""
  echo "Deployment complete. Checking service status..."
  ssh "$target" "sudo systemctl status homarr-container-adapter --no-pager"
}

function deploy-build {
  #@ Build ARM64 and deploy to test server
  #@ Usage: ./run deploy-build [target_host]
  #@ Category: Deploy
  local target="${1:-$DEFAULT_DEPLOY_TARGET}"

  build-arm64
  deploy "$target"
}

function logs {
  #@ Show service logs from test server
  #@ Usage: ./run logs [target_host] [lines]
  #@ Category: Deploy
  local target="${1:-$DEFAULT_DEPLOY_TARGET}"
  local lines="${2:-50}"

  echo "Fetching logs from $target..."
  ssh "$target" "sudo journalctl -u homarr-container-adapter -n $lines --no-pager"
}

function logs-follow {
  #@ Follow service logs from test server
  #@ Usage: ./run logs-follow [target_host]
  #@ Category: Deploy
  local target="${1:-$DEFAULT_DEPLOY_TARGET}"

  echo "Following logs from $target (Ctrl+C to stop)..."
  ssh "$target" "sudo journalctl -u homarr-container-adapter -f"
}

function status {
  #@ Show service status on test server
  #@ Usage: ./run status [target_host]
  #@ Category: Deploy
  local target="${1:-$DEFAULT_DEPLOY_TARGET}"

  ssh "$target" "sudo systemctl status homarr-container-adapter --no-pager"
}

################################################################################
# Development Commands

function install-hooks {
  #@ Install git pre-commit hooks (lefthook)
  #@ Category: Development
  echo "Installing git hooks..."
  if command -v lefthook &>/dev/null; then
    lefthook install
  else
    echo "lefthook not installed. Install with: brew install lefthook"
    exit 1
  fi
}

function clean {
  #@ Clean build artifacts
  #@ Category: Development
  echo "Cleaning build artifacts..."
  cargo clean
}

################################################################################
# Help System

function help {
  #@ Show this help message
  #@ Category: Core
  echo "homarr-container-adapter development commands"
  echo ""
  echo "Available commands:"

  # Extract function definitions and their help comments
  awk '/^function / {
    fname = $2
    sub(/[({].*/, "", fname)
    getline
    if ($0 ~ /#@/) {
      desc = $0
      sub(/.*#@ /, "", desc)
      sub(/ *$/, "", desc)
      # Skip any additional #@ lines until we find Category
      while (getline > 0 && $0 ~ /#@/) {
        if ($0 ~ /#@ Category:/) {
          cat = $0
          sub(/.*Category: /, "", cat)
          sub(/ *$/, "", cat)
          if (!seen[cat]++) categories[++cat_count] = cat
          commands[cat, ++cmd_count[cat]] = fname
          descriptions[cat, cmd_count[cat]] = desc
          break
        }
      }
    }
  }
  END {
    for (i = 1; i <= cat_count; i++) {
      cat = categories[i]
      print "\n" cat ":"
      for (j = 1; j <= cmd_count[cat]; j++) {
        printf "  %-20s %s\n", commands[cat, j], descriptions[cat, j]
      }
    }
  }' "$0"

  echo ""
  echo "Usage: ./run <command> [arguments...]"
  echo ""
  echo "Examples:"
  echo "  ./run build-arm64               # Cross-compile for Raspberry Pi"
  echo "  ./run deploy pi@myhost.local    # Deploy to test server"
  echo "  ./run deploy-build myhost.local # Build and deploy in one step"
  echo "  ./run logs-follow               # Watch service logs"
}

################################################################################
# Commands end.

TIMEFORMAT=$'\nTask completed in %3lR'
time "${@:-help}"
